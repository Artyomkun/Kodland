<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поиск мемов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>M</text></svg>">
    <meta name="description" content="Поиск мемов по всем популярным платформам">
    <meta name="keywords" content="мемы, поиск, картинки, соцсети, Google, TikTok, Instagram">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --text-light: #ecf0f1;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }
        
        .navbar-custom {
            background-color: var(--primary-color);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 70px;
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--text-light) !important;
            font-size: 1.3rem;
            margin-left: 1rem;
        }
        
        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .search-with-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .search-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        
        .search-inputs {
            flex: 1;
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        
        .search-field {
            flex: 1;
            position: relative;
        }
        
        .stats-button {
            min-width: 120px;
        }
        
        .search-button {
            min-width: 120px;
        }
        
        .platforms-dropdown {
            position: relative;
            min-width: 120px;
        }
        
        .platforms-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 0 !important;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 24px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 16px 12px;
            font-weight: normal;
            color: var(--primary-color);
        }
        
        .platforms-select,
        .platforms-select:focus,
        .platforms-select:active,
        .platforms-select:hover {
            border: 0 !important;
            outline: 0 !important;
            box-shadow: none !important;
        }
        
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }
        
        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s;
            font-size: 0.85rem;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .results-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            display: none;
            max-height: 800px;
            overflow: auto;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--primary-color);
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #e74c3c;
        }
        
        @media (max-width: 768px) {
            .container-main {
                padding: 0 0.75rem;
            }
            
            .search-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .search-inputs {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }
            
            .search-field, .platforms-dropdown, .stats-button, .search-button {
                width: 100%;
            }
        }
        
        .form-label {
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-outline {
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            background: white;
        }
        
        .btn-outline:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .history-section {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 2px solid #3498db;
            background-color: #000dff;
            border-radius: 8px;
        }
        
        .history-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #e8f4fc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #d1e7f7;
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            background: #d6eaf8;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        
        .history-platform {
            font-size: 0.75rem;
            color: #2c3e50;
            padding: 0.2rem 0.5rem;
            background: #d1e7f7;
            border-radius: 3px;
            border: 1px solid #a9d0f5;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .content-item {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            border: 1px solid #eee;
        }
        
        .content-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .video-thumbnail {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #ccc;
        }
        
        .content-info {
            padding: 15px;
        }
        
        .content-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .content-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .platform-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .platform-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }
        
        .google-icon { background: #4285f4; }
        .tiktok-icon { background: #000000; }
        .instagram-icon { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); }
        .twitter-icon { background: #1da1f2; }
        .reddit-icon { background: #ff4500; }
        .pikabu-icon { background: #ff5700; }
        
        .meme-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }
        
        /* Стили для полноэкранного просмотра */
        .fullscreen-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .fullscreen-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .fullscreen-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        
        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10000;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fallback-img {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .fallback-img i {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <div class="navbar-brand">Поиск мемов</div>
            <button class="btn btn-primary me-2" onclick="showHistory()" style="color: var(--text-light); border-color: var(--text-light);">История поиска</button>
        </div>
    </nav>

    <div class="container-main mt-4">
        <div class="search-with-controls">
            <h2 class="section-title">Поиск мемов</h2>
            
            <div class="search-row">
                <div class="search-inputs">
                    <div class="search-field">
                        <label class="form-label">Поисковый запрос</label>
                        <input type="text" class="form-control" id="searchQuery" placeholder="Начните вводить запрос..." required autocomplete="off">
                        <div class="suggestions-dropdown" id="suggestionsDropdown"></div>
                    </div>
                    
                    <div class="platforms-dropdown">
                        <select class="platforms-select" id="platformsSelect">
                            <option value="google" selected>Google</option>
                            <option value="tiktok">TikTok</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter</option>
                            <option value="reddit">Reddit</option>
                            <option value="pikabu">Pikabu</option>
                        </select>
                    </div>
                    
                    <div class="stats-button">
                        <button class="btn btn-outline w-100" onclick="showStats()" style="margin-top: 24px;">Статистика</button>
                    </div>
                    
                    <div class="search-button">
                        <button type="submit" class="btn btn-primary w-100" style="margin-top: 24px;">Поиск</button>
                    </div>
                </div>
            </div>
            
            <div class="history-section" id="historySection" style="display: none;">
                <h6>История поиска:</h6>
                <div id="historyList"></div>
            </div>
        </div>

        <div class="results-container" id="resultsContainer">
            <!-- Результаты будут загружаться через AJAX -->
        </div>
    </div>

    <!-- Полноэкранный просмотр -->
    <div class="fullscreen-view" id="fullscreenView">
        <div class="close-fullscreen" onclick="closeFullscreen()">
            <i class="fas fa-times"></i>
        </div>
        <div class="fullscreen-content">
            <img id="fullscreenImg" class="fullscreen-img" src="" alt="">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const PROXY_URL = 'http://localhost:8080/proxy/';
        const searchCache = new Map();
        
        let counters = {
            searches: 0,
            quickSearches: 0,
            platforms: 0
        };
        
        let searchHistory = JSON.parse(localStorage.getItem('memeSearchHistory')) || [];
        const safeSearchEnabled = true;
        
        const popularSearches = [
            "смешные мемы",
            "мемы про котов",
            "новые мемы",
            "мемы про работу",
            "мемы про учебу",
            "мемы про программистов"
        ];
        
        const platformNames = {
            google: "Google Images",
            tiktok: "TikTok",
            instagram: "Instagram",
            twitter: "X (Twitter)",
            reddit: "Reddit",
            pikabu: "Pikabu"
        };
        
        const platformColors = {
            google: "#4285f4",
            tiktok: "#000000",
            instagram: "#e4405f",
            twitter: "#1da1f2",
            reddit: "#ff4500",
            pikabu: "#ff5700"
        };
        
        let isClickingSuggestion = false;
        let lastSuggestionTime = 0;
        
        function updateCounter(counterName) {
            counters[counterName]++;
        }
        
        function showSuggestions() {
            const input = document.getElementById('searchQuery');
            const dropdown = document.getElementById('suggestionsDropdown');
            const query = input.value.trim();
            
            if (query.length > 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = '';
            const limitedSuggestions = popularSearches.slice(0, 4);
            limitedSuggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onmousedown = () => {
                    isClickingSuggestion = true;
                };
                item.onclick = () => {
                    input.value = suggestion;
                    dropdown.style.display = 'none';
                    lastSuggestionTime = Date.now();
                    input.focus();
                    isClickingSuggestion = false;
                };
                dropdown.appendChild(item);
            });
            
            if (limitedSuggestions.length > 0) {
                dropdown.style.display = 'block';
            }
        }
        
        function hideSuggestions() {
            if (!isClickingSuggestion) {
                setTimeout(() => {
                    document.getElementById('suggestionsDropdown').style.display = 'none';
                }, 200);
            }
        }
        
        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const platform = document.getElementById('platformsSelect').value;
            
            if (!query) {
                alert('Введите поисковый запрос');
                return;
            }
            
            updateCounter('searches');
            
            const cacheKey = `${platform}:${query}`;
            
            if (searchCache.has(cacheKey)) {
                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = searchCache.get(cacheKey);
                resultsContainer.style.display = 'block';
                resultsContainer.scrollIntoView({ behavior: 'smooth' });
                
                addToHistory(query, platform);
                return;
            }
            
            // Для всех платформ используем прокси
            loadPlatformContent(platform, query, cacheKey);
        }
        
        function loadPlatformContent(platform, query, cacheKey) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsContainer.innerHTML = `
                <div class="loading">
                    <h4>Поиск на ${platformNames[platform]}...</h4>
                    <p><strong>Запрос:</strong> "${query}"</p>
                    <div class="spinner-border text-primary mt-3" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Получение реальных данных</p>
                </div>
            `;
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            const searchUrl = getPlatformSearchUrl(platform, query);
            console.log(`Поиск на ${platform}: ${searchUrl}`);
            
            const urlObj = new URL(searchUrl);
            const urlForProxy = urlObj.host + urlObj.pathname + urlObj.search;
            const finalUrl = PROXY_URL + urlForProxy;
            
            console.log(`Загружаем через прокси: ${finalUrl}`);
            
            fetch(finalUrl, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7'
                }
            })
                .then(response => {
                    console.log(`Ответ от ${platform}: статус ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    console.log(`${platform} HTML получен, длина: ${html.length} символов`);
                    
                    const images = extractImagesFromHtml(html, platform, query);
                    displayResults(platform, images, query, cacheKey);
                    
                    searchCache.set(cacheKey, resultsContainer.innerHTML);
                    addToHistory(query, platform);
                })
                .catch(error => {
                    console.error(`Ошибка загрузки ${platform}:`, error);
                    showErrorFallback(platform, query, cacheKey, error.message);
                });
        }
        
        function getPlatformSearchUrl(platform, query) {
            const encodedQuery = encodeURIComponent(query);
            switch(platform) {
                case 'tiktok':
                    return `https://www.tiktok.com/search?q=${encodedQuery}`;
                case 'instagram':
                    // Используем публичный поиск через хештеги
                    return `https://www.instagram.com/explore/tags/${encodedQuery}/`;
                case 'twitter':
                    return `https://twitter.com/search?q=${encodedQuery}&src=typed_query`;
                case 'reddit':
                    // Используем поиск по популярным сабреддитам
                    return `https://www.reddit.com/r/memes/search/?q=${encodedQuery}&restrict_sr=1&sr_nsfw=`;
                case 'pikabu':
                    return `https://pikabu.ru/search?q=${encodedQuery}`;
                case 'google':
                default:
                    return `https://www.google.com/search?q=${encodedQuery}&tbm=isch&safe=${safeSearchEnabled ? 'active' : 'off'}&hl=ru`;
            }
        }
        
        function extractImagesFromHtml(html, platform, query) {
            const images = [];
            
            // Улучшенные паттерны для поиска изображений
            const patterns = getExtractionPatterns(platform);
            
            // Ищем по всем паттернам
            patterns.forEach(pattern => {
                try {
                    let match;
                    while ((match = pattern.exec(html)) !== null) {
                        let url = match[1] || match[0];
                        
                        // Очищаем URL
                        url = cleanImageUrl(url);
                        
                        // Проверяем URL
                        if (isValidImageUrl(url, platform)) {
                            const enhancedUrl = enhanceImageUrl(url, platform);
                            images.push({
                                url: enhancedUrl,
                                alt: `Результат поиска: "${query}"`,
                                platform: platform,
                                index: images.length + 1
                            });
                            
                            // Ограничиваем количество изображений
                            if (images.length >= 12) break;
                        }
                    }
                } catch (e) {
                    console.log(`Ошибка при парсинге паттерна:`, e);
                }
            });
            
            // Удаляем дубликаты
            return removeDuplicates(images).slice(0, 12);
        }
        
        function getExtractionPatterns(platform) {
            const basePatterns = [
                /src=["'](https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp)[^"']*)["']/gi,
                /data-src=["'](https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp)[^"']*)["']/gi,
                /srcset=["'](https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp)[^"'\s,]*)["']/gi
            ];
            
            // Платформенные специфические паттерны
            const platformPatterns = {
                google: [
                    /"ou":"(https?:\/\/[^"]+\.(?:jpg|jpeg|png|gif|webp)[^"]*)"/gi,
                    /"src":"(https?:\/\/[^"]+\.(?:jpg|jpeg|png|gif|webp)[^"]*)"/gi
                ],
                tiktok: [
                    /"cover":"(https?:\/\/[^"]+\.(?:jpg|jpeg|png|webp)[^"]*)"/gi
                ],
                instagram: [
                    /"display_url":"(https?:\/\/[^"]+\.(?:jpg|jpeg|png|webp)[^"]*)"/gi
                ],
                twitter: [
                    /src="(https?:\/\/[^"]+\.(?:jpg|jpeg|png|webp)[^"]*)"[^>]*data-testid="tweetPhoto"/gi
                ],
                reddit: [
                    /data-url=["'](https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp))["']/gi,
                    /src="(https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp))["'][^>]*data-test-id="post-image"/gi
                ],
                pikabu: [
                    /src="(https?:\/\/[^"']+\.(?:jpg|jpeg|png|gif|webp))["'][^>]*class="[^"]*story-image[^"]*"/gi
                ]
            };
            
            return [...basePatterns, ...(platformPatterns[platform] || [])];
        }
        
        function cleanImageUrl(url) {
            if (!url) return '';
            
            // Убираем экранированные символы
            let cleaned = url
                .replace(/\\u003d/g, '=')
                .replace(/\\u0026/g, '&')
                .replace(/\\u002f/g, '/')
                .replace(/\\\//g, '/')
                .replace(/\\"/g, '"')
                .replace(/\\'/g, "'")
                .trim();
            
            // Убеждаемся что это абсолютный URL
            if (!cleaned.startsWith('http')) {
                // Если это относительный URL, преобразуем в абсолютный
                if (cleaned.startsWith('//')) {
                    cleaned = 'https:' + cleaned;
                } else if (cleaned.startsWith('/')) {
                    // Пропускаем относительные пути к локальным файлам
                    return '';
                }
            }
            
            return cleaned;
        }
        
        function isValidImageUrl(url, platform) {
            if (!url || url.length < 10) return false;
            
            // Должен быть абсолютный URL
            if (!url.startsWith('http')) return false;
            
            // Проверяем расширение
            const hasImageExtension = /\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(url);
            if (!hasImageExtension) return false;
            
            // Пропускаем локальные файлы и нежелательные изображения
            const skipPatterns = [
                'localhost', '127.0.0.1', 'tia.png', 'favicon', 'logo', 'icon',
                'sponsor', 'advertisement', 'avatar', 'sprite', 'pixel',
                'track', 'analytics', 'loading', 'placeholder', 'blank',
                'default', 'google.com/logos', '/logos/', '/icons/', '/badges/',
                'data:image/', 'base64,', '.gif', '.svg'
            ];
            
            const lowerUrl = url.toLowerCase();
            const shouldSkip = skipPatterns.some(pattern => lowerUrl.includes(pattern));
            
            return !shouldSkip;
        }
        
        function enhanceImageUrl(url, platform) {
            let enhanced = url;
            
            // Для Google изображений увеличиваем размер
            if (platform === 'google' || url.includes('googleusercontent.com')) {
                if (enhanced.includes('=s')) {
                    enhanced = enhanced.replace(/=s\d+-c/, '=s400-c').replace(/=s\d+/, '=s400');
                }
                if (enhanced.includes('w=')) {
                    enhanced = enhanced.replace(/w=\d+/, 'w=400').replace(/h=\d+/, 'h=400');
                }
            }
            
            return enhanced;
        }
        
        function removeDuplicates(images) {
            const unique = [];
            const seen = new Set();
            
            images.forEach(img => {
                // Убираем параметры запроса для сравнения
                const cleanUrl = img.url.split('?')[0].split('#')[0];
                if (!seen.has(cleanUrl)) {
                    seen.add(cleanUrl);
                    unique.push(img);
                }
            });
            
            return unique;
        }
        
        function displayResults(platform, images, query, cacheKey) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (images.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="platform-header">
                        <div class="platform-icon ${platform}-icon" style="background: ${platformColors[platform]}">${platform[0].toUpperCase()}</div>
                        <div>
                            <h4>Поиск: "${query}"</h4>
                            <p class="text-muted">${platformNames[platform]}</p>
                        </div>
                    </div>
                    <div class="error-message">
                        <h4><i class="fas fa-search"></i> Изображения не найдены</h4>
                        <p>Не удалось найти изображения по запросу "${query}" на ${platformNames[platform]}</p>
                        <p class="mt-3">Попробуйте другой запрос или выберите другую платформу</p>
                    </div>
                `;
                searchCache.set(cacheKey, resultsContainer.innerHTML);
                addToHistory(query, platform);
                return;
            }
            
            let html = `
                <div class="platform-header">
                    <div class="platform-icon ${platform}-icon" style="background: ${platformColors[platform]}">${platform[0].toUpperCase()}</div>
                    <div>
                        <h4>Найдено на ${platformNames[platform]}:</h4>
                        <p class="text-muted">Запрос: "${query}" • ${images.length} изображений</p>
                    </div>
                </div>
                <p>Нажмите на изображение для просмотра в полноэкранном режиме:</p>
                <div class="content-grid">
            `;
            
            images.forEach((img, index) => {
                const safeUrl = encodeURIComponent(img.url);
                const altText = img.alt || `Изображение ${index + 1}`;
                const fallbackHtml = `
                    <div class="meme-img fallback-img">
                        <i class="fas fa-image"></i>
                        <span>${platformNames[platform]}</span>
                        <small>Изображение ${index + 1}</small>
                    </div>
                `;
                
                html += `
                    <div class="content-item" onclick="openFullscreen('${escapeHtml(img.url)}', '${escapeHtml(altText)}')">
                        <img src="${img.url}" 
                            alt="${escapeHtml(altText)}"
                            class="meme-img"
                            loading="lazy"
                            onerror="handleImageError(this, '${platform}', ${index})"
                            data-fallback="${escapeHtml(fallbackHtml)}">
                        <div class="content-info">
                            <div class="content-title">${escapeHtml(altText)}</div>
                            <div class="content-description">${platformNames[platform]} • Изображение ${index + 1}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="mt-4 text-center">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Показаны реальные результаты поиска
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
            searchCache.set(cacheKey, html);
            addToHistory(query, platform);
        }
        
        function showErrorFallback(platform, query, cacheKey, error) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Для Instagram и Twitter предлагаем использовать Google
            let alternativeHtml = '';
            if (platform === 'instagram' || platform === 'twitter') {
                alternativeHtml = `
                    <div class="mt-3">
                        <p>Попробуйте поискать через Google:</p>
                        <button class="btn btn-outline-primary" onclick="searchWithGoogle('${escapeHtml(query)}', '${platform}')">
                            <i class="fas fa-search"></i> Поиск через Google
                        </button>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = `
                <div class="platform-header">
                    <div class="platform-icon ${platform}-icon" style="background: ${platformColors[platform]}">${platform[0].toUpperCase()}</div>
                    <div>
                        <h4>Ошибка загрузки</h4>
                        <p class="text-muted">${platformNames[platform]}</p>
                    </div>
                </div>
                <div class="error-message">
                    <h4><i class="fas fa-exclamation-triangle"></i> Не удалось загрузить данные</h4>
                    <p>${error || 'Неизвестная ошибка'}</p>
                    ${alternativeHtml}
                    <button class="btn btn-primary mt-3" onclick="loadPlatformContent('${platform}', '${escapeHtml(query)}', '${cacheKey}')">
                        <i class="fas fa-redo"></i> Повторить попытку
                    </button>
                </div>
            `;
            
            searchCache.set(cacheKey, resultsContainer.innerHTML);
        }
        
        function searchWithGoogle(query, originalPlatform) {
            document.getElementById('platformsSelect').value = 'google';
            document.getElementById('searchQuery').value = query;
            performSearch();
        }
        
        // Функции для полноэкранного просмотра
        function openFullscreen(src, alt) {
            const fullscreenView = document.getElementById('fullscreenView');
            const fullscreenImg = document.getElementById('fullscreenImg');
            
            fullscreenImg.src = src;
            fullscreenImg.alt = alt;
            
            fullscreenView.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeFullscreen() {
            const fullscreenView = document.getElementById('fullscreenView');
            fullscreenView.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Вспомогательные функции
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML
                .replace(/'/g, "&#39;")
                .replace(/"/g, "&#34;");
        }
        
        function handleImageError(img, platform, index) {
            console.log(`Ошибка загрузки изображения ${index} с ${platform}: ${img.src}`);
            
            // Заменяем на fallback контент
            const fallbackHtml = img.getAttribute('data-fallback');
            if (fallbackHtml) {
                const parent = img.parentElement;
                const infoDiv = parent.querySelector('.content-info');
                parent.innerHTML = fallbackHtml;
                if (infoDiv) {
                    parent.appendChild(infoDiv);
                }
                
                // Добавляем обработчик клика
                parent.onclick = () => {
                    openFullscreen(img.src, img.alt || `Изображение ${index + 1}`);
                };
            }
        }
        
        function addToHistory(query, platform) {
            const historyItem = {
                query: query,
                platform: platform,
                timestamp: new Date().toISOString(),
                displayTime: new Date().toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            searchHistory.unshift(historyItem);
            searchHistory = searchHistory.slice(0, 10);
            
            localStorage.setItem('memeSearchHistory', JSON.stringify(searchHistory));
            
            if (document.getElementById('historySection').style.display !== 'none') {
                displayHistory();
            }
        }
        
        function showHistory() {
            const historySection = document.getElementById('historySection');
            if (historySection.style.display === 'none') {
                displayHistory();
                historySection.style.display = 'block';
            } else {
                historySection.style.display = 'none';
            }
        }
        
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (searchHistory.length === 0) {
                historyList.innerHTML = '<p class="text-muted">История поиска пуста</p>';
                return;
            }
            
            searchHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>${escapeHtml(item.query)}</strong>
                        <span class="history-platform">${platformNames[item.platform]}</span>
                    </div>
                    <small class="text-muted">${item.displayTime}</small>
                `;
                
                historyItem.onclick = () => {
                    document.getElementById('searchQuery').value = item.query;
                    document.getElementById('platformsSelect').value = item.platform;
                    performSearch();
                };
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Назначаем обработчики событий
        document.querySelector('.search-button button').addEventListener('click', function(e) {
            e.preventDefault();
            performSearch();
        });
        
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        const searchInput = document.getElementById('searchQuery');
        searchInput.addEventListener('input', showSuggestions);
        searchInput.addEventListener('focus', showSuggestions);
        searchInput.addEventListener('blur', hideSuggestions);
        
        // Закрытие полноэкранного режима
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });
        
        document.getElementById('fullscreenView').addEventListener('click', function(e) {
            if (e.target === this || e.target.classList.contains('fullscreen-img')) {
                closeFullscreen();
            }
        });
        
        function showStats() {
            const statsText =   `Статистика поиска:\n\n` +
                                `Всего поисков: ${counters.searches}\n` +
                                `История запросов: ${searchHistory.length}\n` +
                                `Безопасный поиск: ${safeSearchEnabled ? 'ВКЛ' : 'ВЫКЛ'}\n\n`;
            alert(statsText);
        }
        
    </script>
</body>
</html>